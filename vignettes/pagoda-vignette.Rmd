---
title: "Practical applications of brainmapr"
author: "Jean Fan"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

`brainmapr` visualizes 3D ISH gene expression data from the Allen Brain Atlas. Our goal is to spatially place a group of neuronal cells within a region of the brain based on their gene expression signature. 

Load embryonic 13.5 day old mouse data. 

```{r}
library(brainmapr)
# Load data
load('data-raw/RData/sids.RData')
load('data-raw/RData/E13.5.energy.RData')
load('data-raw/RData/E13.5.annot.RData')
```

Plot slice of whole mouse.

```{r, fig.show='hold'}
s <- 26 # slice
s2 <- round(s/dim(gannot3D)[3]*dim(vol3D)[3]) # convert
plot.slice.xray(vol3D, s2, t=15)
```

Get forebrain.

```{r, fig.show='hold'}
# Plot x-ray of just brain component
# Forebrain
cids1 <- get.structure.ids(structure.id, 'forebrain')
cids2 <- get.structure.ids(structure.id, 'ventricles, forebrain')
cids <- unique(c(cids1, cids2))
# Plot brain component; note section annotation data is for the left hemisphere only
sect3D <- structure.plot(cids, vol3D, annot3D, plot=F)
plot.slice.xray(sect3D, s2, t=0)
```

Gene expression signatures for proximal distal cell group identified by `pagoda`.

```{r, fig.show='hold'}
# Plot gene expression
# Upregulated genes
gl1  <- c("Dlx2", "Dlx6as1", "Sp9", "Pbx3", "Dlx5", "Dlx1", "Necap1", "Zfhx3", "Pou3f4", "Sec63", "Gdi1", "Rbp1", "Rbmx", "Nrxn3", "Map3k13", "Meis1", "Slc6a1", "Sp8", "Pbx1", "Dcx", "Gad2", "Sirt7", "Hmgcll1")
# lb * cZ
weights1 <- c(46.26915, 38.06011, 33.33369, 36.56755, 43.52929, 39.49066, 14.35763, 4.262908, 8.896505, 3.521533, 1.94611, 5.004284, 1.760767, 9.089976, 6.999584, 8.525134, 4.538585, 3.559675, 1.706482, 2.031702, 3.470824, 6.661706, 5.606481)
gp <- gene.plot(gl1, mat, gannot3D, plot=F, weights1)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.slice(vol3D, s2, col=colorRampPalette(c("white", "grey"),space="Lab")(100), t=15)
plot.projection(gpsect, t=1, add=T)
plot.slice(gpsect, s, t=1)



# Downregulated genes
gl2 <- c("Celsr1", "Sp1", "Adck2", "Dkk3", "Bms1", "Eif2c3", "Bhlhe22", "Rcan2", "Tmem115", "Zfp654", "Smap1", "Map2k6", "Cadm4", "B4galt4", "Etl4", "Qsox2", "Hist1h1c", "1810041L15Rik", "Thap7", "Fuca1", "Stard4", "Rap1gds1", "Fam84b", "Pigh", "Ogfrl1", "Mdm1", "Syde2", "Gm166", "Ccdc171", "BC023829", "9230110C19Rik",
         "Lin9", "Clpp", "Xrcc4", "Vrk3", "Cdk5rap1", "Lrr1", "Spty2d1", "Ext2", "Tex261", "1810044D09Rik", "Gpr156", "2410127L17Rik", "Pdp2", "E2f8", "Tenm4", "D3Ertd751e", "Prtg", "Mrps26", "Rabac1", "Chaf1b", "Gm17762", "Trim3", "Cpeb2", "Rmi1", "Klf16", "Echdc1", "Hdac7", "Gadd45a", "Myo7a", "Safb2", "Scml2", "Pbk",
         "Slc16a1", "Atp2b1", "Polr3h", "Mlst8", "Cradd", "Avl9", "Ndc80", "Ift74", "Eomes", "Slit2", "Phf13", "Oscp1", "Cd9", "Nufip1", "Sft2d2", "Col18a1", "Mipep", "Lamb1", "Rrp15", "Rfxap", "Neurod2", "Melk", "Wdr35", "Fam53b", "Faim", "Ankib1", "Pim3", "Tcn2", "Sptlc1", "Lmf1", "2700050L05Rik", "P4ha1", "Ugdh",
         "2510003E04Rik", "Unc50", "Trappc6a", "Urm1", "Ccdc117", "Zdhhc24", "Osbpl5", "Spg20", "Prrc1", "Sh3pxd2a", "Tef", "Cbln2", "AI414108", "Znrf3", "Phlpp2", "Mpp6", "Dhx33", "Spg21", "Ankrd40", "Smyd5", "Fbln1", "Sapcd2", "Rnft1", "Nfix", "Wee1", "Vkorc1l1", "Zfp574", "Nap1l2", "Dusp14", "Ccdc112", "Epb4.1l2",
         "1810055G02Rik", "Kctd3", "Hap1", "Ccdc40", "Wdr3", "Synpr", "Arhgap31", "Zc3h7a", "Cenph", "Gpank1", "Kdm2a", "Smad3", "1190002N15Rik", "Ptar1", "Klf6", "Lpar4", "Uaca", "Stk24", "Tmem248", "Lipt1", "Hmga2", "Rnf26", "Asb1", "Add3", "Ankzf1", "Fbxo25", "Zfp955b", "Fbxl6", "Bcl2l12", "Cystm1", "Thop1", "Trmt13",
         "Tmem179b", "Slu7", "Nucb1", "Scd1", "Nptx1", "Ppap2c", "Pcdh18", "Nrxn1", "Lap3", "Asb3", "Ano1", "Arhgef25", "Acad8", "Pgap2", "Fam179b", "Tceb3", "Tnik", "Dap3", "Slc25a24", "E2f6", "Sox3", "Cyth3", "Tspan12", "1700102H20Rik", "Dgkd", "Maml1", "Fgfr2", "Klhdc4", "Incenp", "Vcam1", "Atl3", "Rai2", "Tm7sf2", "Napepld",
         "Fert2", "Cldn12", "Itpr1", "Katnb1", "Hyal2", "Gys1", "Mcu", "Pacrgl", "Aldoc", "Lhpp", "Pi4k2b", "Rem2", "Polr3a", "Ptpn13", "2310039H08Rik", "Col11a1", "Dph2", "Ddrgk1", "Tmem101", "Gas2", "Cdc45", "Tmem126b", "Pofut2", "Cep68", "Npc1", "Lpar1", "Adamts20", "Bcl10", "Mir135a-2", "Snap23", "Sesn1", "Pde3b", "Slk", "Dennd1b",
         "Plk1s1", "Trak1", "Galnt7", "E2f7", "Rpia", "2010204K13Rik", "Mbd1", "Tmem178", "Gmds", "2010107G23Rik", "Rab30", "Zbed3", "Coasy", "Fntb", "Wnt8b", "Ndn", "Rspo3", "Dnajb12", "Map4k3", "Caml", "Tceal1", "Cdpf1", "C1galt1c1", "Smap2", "Ece2", "Pvrl2", "Noc4l", "Trps1", "Nubpl", "Fgfbp3", "Pold1", "Sil1", "Zmym1", "2310035C23Rik",
         "Cluh", "Rexo2", "Frrs1l", "Sstr2", "Herc3", "Slc25a36", "Fahd1", "Fam196a", "Alcam", "Atrip", "Smpd2", "Hdgfrp2", "Tanc1", "Pspc1", "Gusb", "Dgcr6", "Slc30a10", "Flrt2", "Gdap2", "Zfp770", "Tmem110", "Prr15", "Hsd17b7", "Per3", "Tiparp", "Gcat", "AW554918", "Ogfr", "Gne", "Ap4m1", "Mlf1", "Ppp4r2", "Pms1", "Tmed5", "Mtg1",
         "Fars2", "Dbndd1", "Tmem251", "Cdk2ap2", "Dennd1a", "Prdm5", "Ercc3", "Fam169a", "Vps52", "Nynrin", "1700020I14Rik", "Athl1", "Asrgl1", "2700099C18Rik", "Obfc1", "Necab3", "Adnp2", "Nckap5", "Ptgr1", "Ptpmt1", "Zscan22", "Msto1", "Sdc4", "Rgcc", "Vkorc1", "Hist1h4i", "Tmem14a", "Wfdc2", "Baiap2l1", "Gemin6", "D330022K07Rik",
         "C430049B03Rik", "Slc35b2", "Ext1", "Brca1", "Rnf11", "Zbtb17", "Dtd2", "Sap30l", "Akip1", "Zfp449", "Mpp5", "Kbtbd11", "Zmym3", "Tmed3", "2700097O09Rik", "Slc9a1", "2810408I11Rik", "Nup43", "Zfp276", "Gm15545", "Zfyve16", "Rcn3", "Ccrn4l", "Ift172", "Pgs1", "Rwdd3", "Mettl23", "Chrna3", "Ttc8", "Ndufaf1", "Zfp719", "Bre",
         "Dpm1", "Gm11627", "Exoc6b", "Eme1", "Ccdc138", "Hunk", "Wdr60", "Fam173b", "Cntn5", "Grtp1", "Nedd9", "Gtf2h4", "Tfap2c", "Fut9", "Osbpl11", "0610007N19Rik", "Fndc3c1", "Slc17a7", "Prosc", "Ngly1", "Nme3", "Neurod1", "Pcp4", "Cdk19", "Coq4", "Smim8", "Elmod3", "Cad", "2810002D19Rik", "Sc5d", "BC030867", "Gpc3", "Pafah2", "Hadhb",
         "Usp25", "Itm2a", "Plekhf2", "Pef1", "Pcsk6", "Dach2", "Sat1", "Prokr1", "Zkscan17", "Pold3", "Nkrf", "Mmd2", "Alad", "Enpp5", "Man1b1", "Traf3ip1", "Fut10", "Ptplb", "Dnajb2", "BC022687", "Ift122", "Jph1", "1110012L19Rik", "Cdk5rap2", "Dym", "Abhd6", "A330048O09Rik", "Nop14", "Gm9958", "Zufsp", "Emx1", "Qtrt1", "Lman1", "Ppp1r14a",
         "Stx8", "Adck5", "Tmem216", "Plxna4", "Pdha1", "Appl2", "Coil", "Slc17a6", "Hs3st1", "Slc35a2", "Zfp36l2", "Atxn1l", "Blvra", "Cables2", "Ttpal", "2210016L21Rik", "Lrrc57", "Aspscr1", "Spice1", "Lmcd1", "Bora", "Ddx28", "Gemin2", "Gba", "Ralb", "Cdt1", "Prelid2", "Hey1", "5330426P16Rik", "A730017C20Rik", "Cntrob", "Bivm", "Rtn2", "Neurod6",
         "Sh3gl1", "Phldb2", "Galnt14", "Pgm1", "Esco2", "Msl3", "Cbln4", "Zfp763", "Mecr", "Gpr89", "Lsm10", "Coq9", "Akap10", "Shmt2", "Nhlh1", "Ubox5", "Lrrn1", "Cep57l1", "Adamts10", "Mterfd3", "Prim2", "Tnfaip8", "Gpr19", "Masp1", "Jag1", "Enoph1", "Mgme1", "Suclg2", "Pinx1", "Ube2t", "Arl6", "Cers2", "2810055G20Rik", "Tmem132c", "Atic", "Actr1b",
         "Asah1", "Nfia", "Rprd1a", "Neurog2", "0610031J06Rik", "Otx1", "Litaf", "Nr2e1", "Plp2", "Ankrd13c", "Uchl5", "Taf12", "Serpini1", "Gja1", "Nfib")
weights2 <- c(13.61864, 14.61415, 12.08321, 10.71039, 14.41029, 9.096843, 11.57122, 11.90863, 11.66958, 12.82011, 12.98447, 15.12115, 9.209305, 12.82725, 14.80067, 13.23838, 10.12313,
              14.07884, 14.08529, 11.53182, 13.09685, 14.08529, 13.67344, 11.37786, 11.37786, 13.36228, 10.41103, 10.10093, 9.606883, 14.74488, 12.03396, 14.68973, 17.09652, 12.03396,
              13.61946, 10.7984, 9.151281, 10.74603, 11.32915, 10.91604, 12.0034, 11.02835, 14.56363, 12.7291, 10.22225, 13.8366, 11.24725, 11.08771, 10.24773, 12.09757, 15.28999, 10.66939,
              14.44988, 12.52891, 12.5483, 10.69896, 10.69896, 13.22628, 12.72598, 11.37924, 13.32341, 10.625, 16.38446, 13.25959, 15.63164, 14.19521, 9.473503, 11.76694, 14.00611, 14.95135,
              17.24502, 13.84699, 14.8664, 10.87371, 10.61886, 13.59214, 12.99748, 14.78145, 10.87371, 14.44556, 10.53676, 14.53523, 10.9089, 14.74563, 14.8464, 12.45732, 12.71329, 14.8464,
              14.5051, 12.0307, 10.06825, 11.00681, 11.34999, 12.69911, 13.39316, 14.34291, 10.73571, 13.82759, 10.05256, 14.38757, 15.73909, 12.62815, 11.59022, 12.63262, 11.59432,
              11.8539, 10.72908, 13.93049, 11.42467, 13.07825, 14.91031, 13.26324, 12.16026, 14.10128, 10.88062, 11.75469, 15.06536, 14.71703, 11.49496, 13.49787, 14.8912, 10.79829,
              14.10745, 11.32921, 15.51246, 11.24218, 12.98575, 15.34549, 13.34012, 10.12108, 12.9131, 11.95335, 12.3896, 11.95335, 14.57087, 10.81909, 16.05413, 14.13461, 12.5641, 13.61111,
              11.27084, 12.58141, 12.66878, 11.62033, 10.59083, 16.45585, 11.46658, 18.81919, 15.06599, 15.50395, 15.59154, 11.33856, 15.55755, 10.54749, 15.20597, 13.71174, 11.35899, 14.2745,
              13.12901, 15.60724, 15.95995, 15.25453, 14.55213, 11.90629, 11.37712, 14.99311, 13.67019, 16.31603, 16.66881, 12.52365, 14.58196, 12.37257, 12.04586, 15.4319, 16.05273, 14.74214,
              16.69591, 11.63385, 15.54141, 13.76525, 15.18618, 16.25187, 10.21293, 14.3869, 11.36743, 15.63022, 16.16498, 15.89852, 16.34262, 10.6738, 10.8517, 11.38539, 12.45277, 15.56597,
              10.76802, 12.99281, 16.28551, 16.10753, 11.65793, 13.00968, 14.61361, 13.3661, 15.41557, 10.79827, 10.97676, 14.45719, 12.85084, 15.9743, 16.15279, 15.90458, 16.08463, 14.26838,
              15.88367, 15.43498, 13.28126, 11.4865, 15.52472, 12.56336, 15.16577, 13.99917, 15.88367, 11.66597, 13.01205, 15.16577, 14.09358, 14.9015, 15.44011, 12.49463, 13.75309, 15.64076,
              15.47179, 11.78375, 11.78375, 12.95313, 15.6517, 15.74165, 14.84213, 14.67065, 14.77473, 12.79275, 16.39635, 13.60356, 14.51291, 16.76647, 10.36636, 14.96362, 16.58618, 12.64003,
              16.25147, 10.9246, 11.5566, 15.89032, 15.80004, 15.07775, 13.81375, 14.89718, 12.91089, 14.17489, 11.46631, 15.25832, 15.16804, 11.5566, 15.25832, 16.16118, 15.43889, 11.01488,
              12.1886, 11.91774, 16.07089, 13.63317, 15.80004, 13.90403, 13.99432, 12.36917, 15.43889, 12.8206, 16.61261, 15.25832, 15.98061, 15.07775, 15.07775, 11.82746, 9.841166, 13.00117,
              14.26518, 16.25147, 16.25147, 14.44575, 14.71661, 15.98061, 12.73032, 16.43204, 16.07556, 15.98636, 12.92251, 15.96586, 16.05658, 9.986869, 16.09098, 16.54553, 13.5527, 11.73354,
              15.64746, 15.37637, 15.31162, 16.45403, 16.09669, 15.46323, 15.82922, 11.71179, 16.80268, 16.34359, 16.43541, 15.60905, 12.76269, 13.40542, 10.65088, 16.52723, 14.23178, 16.34359,
              16.73998, 16.38034, 16.22932, 16.69038, 11.06544, 16.79128, 10.42703, 12.75515, 14.32643, 14.97343, 15.80529, 15.89772, 15.71286, 14.60372, 10.64724, 13.98703, 15.56888, 15.75423,
              13.99346, 12.78873, 17.05163, 16.95896, 16.31026, 14.08613, 17.05163, 11.12063, 11.02796, 16.58827, 16.86629, 16.21759, 11.86201, 15.93957, 17.42232, 17.42232, 15.10552, 17.05163,
              13.80812, 11.86201, 16.77362, 17.60767, 12.60338, 15.8469, 14.54949, 11.58399, 14.73484, 16.77362, 13.06674, 12.04735, 12.04735, 16.40293, 16.58827, 17.05163, 16.86629, 14.92018,
              15.47621, 16.86629, 10.65727, 14.08613, 12.78873, 16.77362, 18.07102, 15.47621, 12.14002, 16.31026, 16.31026, 11.58399, 13.90079, 16.4956, 15.93957, 15.29087, 15.66155, 12.51071,
              16.86629, 12.60338, 17.32965, 15.01285, 15.10552, 12.14002, 13.06674, 15.93957, 15.01285, 16.40293, 16.58827, 12.69605, 17.14431, 16.77362, 12.32537, 15.10552, 14.36415, 12.51071,
              14.73484, 14.27148, 16.95896, 12.60338, 15.75423, 17.23698, 13.5301, 15.75423, 14.64216, 16.40293, 15.8469, 11.67666, 16.68095, 16.68095, 16.21759, 15.93957, 13.25208, 17.14431,
              12.97407, 16.95896, 16.12491, 17.23698, 12.78873, 13.80812, 17.23698, 17.42232, 14.36415, 16.4956, 15.56888, 13.06674, 16.21759, 16.31026, 13.43743, 16.86629, 12.69605, 15.66155,
              15.47621, 16.21759, 16.40293, 17.05163, 14.82751, 13.43743, 13.06674, 15.47621, 15.01285, 16.12491, 16.31026, 13.06674, 16.12491, 16.4956, 17.51499, 17.14431, 16.12491, 14.64216,
              15.66155, 15.66155, 15.8469, 13.43743, 16.03224, 16.77362, 16.31026, 17.70034, 16.58827, 15.01285, 16.77362, 16.77362, 16.4956, 17.14431, 16.4956, 16.12491, 17.14431, 15.47621,
              13.99346, 16.12491, 14.36415, 15.01285, 13.80812, 16.68095, 15.56888, 16.86629, 16.77362, 17.60767, 17.42232, 17.51499, 17.42232, 17.60767, 16.77362, 17.51499, 11.2133, 16.68095,
              17.14431, 16.86629, 14.64216, 16.95896, 15.56888, 17.60767, 16.77362, 17.23698, 17.70034, 19.3685, 18.97918, 61.6922)
gp <- gene.plot(gl2, mat, gannot3D, plot=F, weights2)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.projection(gpsect, col=colorRampPalette(c("black","red", "yellow"),space="Lab")(100), t=0)
plot.slice(gpsect, 'z', s, col=colorRampPalette(c("black","red", "yellow"),space="Lab")(100), t=0)

# Comparison
gp <- gene.plot.weighted.comp(gl1, weights1, gl2, weights2, mat, gannot3D, plot=F)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.slice.comp(gpsect, s)

# Necdin group
gl1 <- c("Ndn", "Fjx1")
weights1 <- c(47.41178, 6.531084)
gp <- gene.plot.weighted(gl1, weights1, mat, gannot3D, plot=F)
# no upregulated genes in Allen Brain Atlas
gl2 <- c("Ift122", "Chfr", "Rbp1", "Gmds", "Cc2d1b", "3830406C13Rik", "Safb2", "Loh12cr1", "Flywch2", "Rasl11a", "Sirt7", "Tmem184c", "2510009E07Rik", "Dolpp1", "Zfp687", "Fahd1", "Gapdhs", "Dlx2", "Zmpste24", "Zcchc4", "Arfgap3", "Megf10", "Ambra1", "Mcm10", "Lnx1", "Rmdn1", "Pbx3", "Tmem87b", "Gm9958", "Map3k13", "Ankrd39", "Dlx1", "Ndst2", "Tpgs1", "Cyb561d2", "Tcf19", "0610007N19Rik", "Hexa", "Chl1", "Srd5a1", "Zfp868", "Ano10", "Pou3f4", "Kif20b", "Fcho1", "Slc15a2", "Pcca", "Lin37", "Chrna3", "Aurkb", "Fsd1", "Cers5", "Dus2l", "Pnpt1", "Rnf216", "Jam2", "Rdh14", "Fancm", "Sall3", "Mettl20", "Trmt10c", "Cenpn", "Txndc5", "Rpap1", "Fbxw17", "Bmpr1b", "Ddit3", "Osbp", "Kdelc1", "Rnf40", "Pcdh18", "Serpinb6a", "Rai14", "Lrrfip2", "Rbm12b1", "Sp9", "Tubgcp4", "Cpt1c", "Slc30a10", "Gstm1", "Slc38a10", "Gemin2", "Nat6", "Urod", "Ddx20", "Ptpn12", "Blzf1", "Fam45a", "Ticrr", "Cep55", "G6pc3", "Lpar1", "Extl2", "Taf13", "0610031J06Rik", "Rgs19", "Lrrcc1", "Toe1", "Exo1", "Haus8", "Med20", "Spon1", "Brca2", "Ginm1", "Scn8a", "Cdca2", "Zfp612", "Lonp1", "Prmt8", "Kif23", "Nthl1", "Foxn2", "Tceanc2", "Keap1", "Dnph1", "Dlx5", "Ascc1", "Cep290", "Aspm", "2810055G20Rik", "Dlx6as1", "Gskip", "Tfap2c", "Aurka")
weights2 <- c(12.64191, 12.82971, 13.49271, 14.2369, 13.99143, 14.89147, 13.33686, 10.8004, 14.31872, 14.2369, 13.00958, 14.2369, 12.92776, 12.35501, 10.80782, 12.19974, 9.997253, 14.76813, 13.95985, 10.2646, 12.08146, 14.55736, 14.74871, 14.53841, 14.67821, 14.76208, 13.44017, 13.02017, 10.92014, 10.41613, 10.50014, 14.95219, 14.70019, 12.09616, 12.76816, 14.86819, 14.32362, 14.32362, 12.38572, 14.7723, 12.80453, 14.08498, 15.19471, 15.02398, 11.60944, 14.93862, 14.76789, 15.32065, 13.52326, 14.46475, 14.72152, 13.1809, 15.40624, 15.40624, 13.69444, 14.97829, 14.80711, 15.23579, 14.55103, 14.10171, 15.04756, 15.13354, 14.20567, 12.31777, 11.80094, 15.59074, 15.2392, 14.10714, 14.62963, 14.71671, 14.19422, 15.32628, 15.58752, 14.71671, 13.49757, 14.71671, 15.41336, 15.32628, 14.62963, 13.67174, 15.58752, 15.76168, 16.11001, 16.37125, 15.93585, 14.62963, 15.76168, 15.76168, 14.89087, 14.71671, 14.89087, 15.32628, 15.32628, 15.76168, 16.11001, 14.80379, 15.93585, 12.27844, 15.58752, 15.50044, 15.41336, 15.32628, 14.97795, 15.93585, 16.28417, 15.32628, 15.2392, 13.23633, 15.76168, 15.93585, 15.32628, 15.76168, 13.75882, 15.32628, 15.76168, 16.02293, 16.19709, 15.93585, 14.71671, 16.37125, 15.6746, 16.02293, 16.11001, 16.63249)
gp <- gene.plot.weighted(gl2, weights2, mat, gannot3D, plot=F)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.projection(gpsect, col=colorRampPalette(c("black","red", "yellow"),space="Lab")(100), t=0)
plot.slice(gpsect, 'z', s, col=colorRampPalette(c("black","red", "yellow"),space="Lab")(100), t=0)
# Comparison
gp <- gene.plot.weighted.comp(gl1, weights1, gl2, weights2, mat, gannot3D, plot=F)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.slice.comp(gpsect, 'z', s)

# Top split group 1
gl1 <- c("Kif23", "Rad51", "Pole", "Mcm10", "Pabpc4l", "Pola1", "Ifi30", "Tmem97", "Cdc6", "Cdca5", "Gins2", "Prdx1", "Ticrr", "Car14", "Mis18bp1", "Kntc1", "Cdc45", "Wee1", "Poc1a", "Mgme1", "Ncaph", "Exo1", "Isyna1", "Rad54b", "Shmt1", "Sgol1", "Shcbp1", "Vcam1", "Bora", "Hmgb2", "Cenpn", "Esco2", "Espl1", "Pole2", "BC030867", "Zfp367", "Sox3", "Pus3", "Ndc80", "Pold1", "2810408I11Rik", "Lpar1", "Lhfpl2", "Ccnf", "Gpx7", "BC055324", "Megf10", "Fgfbp3", "Cdt1", "2700099C18Rik", "Arhgef39", "Suv39h2", "Trps1", "Clspn", "Siva1", "Gulp1", "Setdb2", "Rpa2", "Wwtr1", "Ak4", "Ing5", "Crip1", "Orc1", "Acrbp", "Arhgap31", "Rad50", "Rragb", "Med26", "Samhd1", "Lpcat1", "Dhx32", "Mms22l", "B330016D10Rik", "Clu", "Gm11627", "Dctd", "Dleu2", "Atad5", "Fgfr2", "Pxdn", "H2afz", "Ran", "Tyms", "Kbtbd11", "Hist1h1b", "Ercc6l", "Syde2", "D3Ertd751e", "2810417H13Rik", "Scml2", "Kif2c", "Kif22", "Depdc1a", "Tmem98", "Tyro3", "Ccdc77", "Adat1", "Tk1", "Sfxn5", "BC052040", "Mybl2", "Sox2", "Gm3893", "Ptpru", "Fn1", "Npm1", "Mad2l1", "Fbxo30", "Etl4", "Rpsa", "Aif1l", "Hmgn2", "Lrrc1", "Cad", "Hes1", "Hmgb1", "Msrb2", "Ogfod3", "Cluh", "Hells", "Diap3", "Gapdh", "Cenph", "Kif14", "Thoc3", "Dusp16", "Rev1", "9430015G10Rik", "Traf3", "Exosc8", "Rad51ap1", "Cdk2", "Ppic", "Neil3", "Tom1l1", "Prr14", "Xpo4", "Tgfb2", "Arhgap17", "Igflr1", "Gpx8", "Paics", "Hirip3", "Gen1", "Polq", "Fbxo5", "Uck1", "Tcf7l2", "Mipep", "Dnaaf2", "0610007N19Rik", "Actn1", "Atp5sl", "Pla2g12a", "Cdca7", "Scd1", "Tuba1b", "2610015P09Rik", "Mir3112", "Gtse1", "Nedd9", "Cry1", "Nasp", "Exosc7", "Iqcc", "Tmem110", "Acot1", "Grb10", "S1pr1", "Ckap2", "Coq10a", "Idi1", "Cdca7l", "Incenp", "Mettl16", "Mdk", "Haus5", "Cks1b", "Tmed5", "Pdpn", "Gpc3", "Gar1", "Igsf11", "Msh6", "Mif", "Zfp36l1", "Igfbp5", "Mns1", "Dgkd", "Sdc1", "Zfp748", "Kazn", "Prr15", "Top2a", "Etaa1", "Sapcd2", "Notch2", "Agpat3", "Gatad2a", "Nde1", "Dnajc3", "Gmds", "Psat1", "Fras1", "Cenpm", "Casc5", "Adamts6", "Zadh2", "Mt1", "Zfp579", "Mki67", "Set", "Sfrp2", "4930422G04Rik", "Zfyve21", "Ddx51", "Gas1", "Haus3", "Ect2", "Fam84b", "Cenpp", "Rlbp1", "Nmral1", "Hist1h4i", "Bmpr1b", "Chtf18", "Metrn", "Nrde2", "Lrr1", "Mir17hg", "Hspd1", "Sav1", "Fzd10", "Fndc3c1", "Slbp", "4931417G12Rik", "Hn1l", "Six5", "Enoph1", "Ccnd2", "Kif4", "Gorab", "1190002F15Rik", "Gins1", "Wnt5b", "Snap23", "Cln3", "Gm8096", "Cpped1", "Jmy", "Fam229b", "Ajuba", "Stard4")
weights1 <- c(25.70137, 29.59888, 29.76567, 24.68016, 20.78329, 30.52546, 12.57898, 23.69041, 24.49737, 21.06707, 32.37425, 5.917703, 19.79369, 21.01805, 25.45902, 22.69036, 23.80137, 21.25906, 16.99061, 18.17822, 17.96696, 17.36431, 17.05992, 14.48438, 21.92231, 19.96471, 17.36249, 19.89858, 15.78619, 6.346554, 17.87554, 20.61649, 5.917697, 19.22824, 16.48714, 22.7253, 13.72571, 13.32367, 19.62173, 16.07113, 15.13676, 21.24849, 14.2775, 16.07539, 14.12963, 11.73834, 15.93613, 10.93345, 11.10596, 9.628688, 9.79836, 16.14695, 14.06795, 23.8073, 7.214335, 10.8215, 11.636, 20.89295, 8.902458, 7.897001, 17.6958, 6.402814, 9.927401, 9.585663, 8.215373, 15.92776, 8.194774, 6.135632, 10.93828, 7.952126, 16.78108, 16.1418, 2.070826, 6.528858, 9.800817, 11.02213, 9.256968, 16.95434, 12.59132, 8.249959, 2.740084, 2.878239, 4.189773, 14.78767, 18.76207, 1.33938, 5.344057, 6.081742, 6.228143, 3.545454, 9.881127, 20.20164, 3.719686, 12.51794, 11.40345, 12.55717, 7.988526, 16.67645, 8.497081, 5.096289, 2.680227, 16.3119, 3.742364, 5.846637, 17.05004, 1.718221, 10.56812, 9.421022, 14.12226, 1.699372, 17.3678, 2.077661, 0.6450837, 12.12757, 12.55257, 1.53705, 10.15608, 2.53861, 8.247943, 12.41625, 1.642412, 1.629888, 5.639646, 3.234741, 12.14668, 4.45925, 9.412865, 5.930603, 7.660363, 3.666648, 2.547089, 11.78479, 12.261, 2.025131, 4.379496, 11.31754, 1.280813, 2.444286, 5.080282, 1.151702, 4.837149, 1.957394, 10.35392, 1.138974, 1.366205, 12.28883, 1.020337, 13.09234, 6.433306, 6.510424, 9.765636, 10.70904, 1.219111, 7.532179, 5.637852, 5.4065, 1.321662, 8.798219, 1.094809, 1.092081, 0.9728729, 0.9702798, 2.048368, 2.667087, 5.972456, 3.175221, 0.2115612, 2.327173, 0.2101568, 5.848486, 0.8351951, 2.916965, 3.436796, 9.419663, 8.348403, 1.2368, 8.347702, 1.748644, 8.086359, 8.802871, 8.393264, 6.835873, 3.0586, 10.96285, 1.116587, 4.741809, 7.759272, 7.842224, 7.012087, 6.010361, 4.607943, 5.191336, 3.076776, 3.572298, 1.765293, 0.7824073, 7.956223, 7.234441, 2.122103, 5.009876, 6.250351, 0.7641022, 2.843459, 0.7556067, 6.598702, 8.607848, 4.863156, 0.09266894, 6.300077, 0.8268156, 3.471054, 0.8220918, 4.737982, 8.173211, 4.712872, 0.09035995, 5.151065, 4.966644, 5.934447, 3.802551, 7.073224, 0.4405537, 1.760735, 6.330614, 6.589453, 7.280396, 0.8713346, 5.207967, 0.4322329, 4.748665, 1.033637, 0.8578934, 0.08547415, 7.000531, 1.535777, 0.0850716, 4.053823, 0.4203083, 6.716998, 0.9235872, 6.528929, 5.439931, 3.548127, 5.280641, 0.3300401, 2.31028, 4.680702, 0.08206534, 3.604325, 6.05617, 4.008056, 3.190085, 0.6513329)
gp <- gene.plot.weighted(gl1, weights1, mat, gannot3D, plot=F)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.slice(gpsect, 'z', s, col=colorRampPalette(c("black", "red", "yellow"),space="Lab")(100), t=0)
# Top split group 2
gl2 <- c("Ftl1", "Stmn3", "Rnf185", "Serinc5", "Plk3", "Nfasc", "Apc", "Khdrbs2", "1810041L15Rik", "Celsr3", "Klhdc5", "Plch2", "Tram1l1", "Plcl1", "Calcoco1", "Gm2694", "2510009E07Rik", "Srgap1", "Klf7", "Nhlh2", "Nsg2", "Tmtc4", "Nkain3", "Actr2", "Wdr83", "Ina", "Celf3", "Pak7", "Slc4a8", "Gpr19", "Fam5b", "Gpr137", "Atp6v1g1", "Shisa7", "Neurod1", "Slc35a1", "Nme3", "Fkbpl", "Apc2", "Frmd4b", "Clvs1", "Evl", "Dcc", "Kif3c", "Ank", "Mbnl2", "Tubb4a", "Brwd3", "Cacna2d1", "Sgip1", "Itm2b", "Ccser1", "Ndfip2", "Klhl29", "Yod1", "Vcan", "Ppm1a", "Hn1", "Atl1", "Fam84a", "Atp6v1f", "Atg16l1", "Rbfox1", "Pcnxl4", "Jakmip2", "Rab3d", "Stxbp1", "Tspyl4", "St8sia3", "Mon2", "Shank1", "Cabp1", "Slc27a4", "Ptprs", "Jup", "Pcdh7", "Rfx3", "Ankzf1", "Kdm6b", "Hist3h2a", "Gramd1a", "Cdk14", "Lcor", "Elavl4", "Slco5a1", "Tmem44", "Cntfr", "Ikbkb", "Ptpro", "Mfap4", "Ankrd12", "Trim46", "Atp6v1e1", "Pcp4", "Gcdh", "Necab3", "Cpeb4", "Rab3a", "Nuak1", "9330133O14Rik", "Frmd5", "Frrs1l", "Rcan2", "Prdm8", "Selk", "Cdyl2", "Dhtkd1", "Kcnq2", "Vps37c", "Actg1", "Gas8", "Rwdd3", "Sema6d", "Ypel5", "Cttnbp2", "Islr2", "Neurod6", "Cbln2", "Ncan", "Fam57b", "Atg9a", "Ppp1r14a", "Cdk5r1", "Kalrn", "Snap91", "Tanc2", "Crmp1", "Edil3", "Kif5a", "Ralgps1", "Disp2", "Ass1", "Tmsb4x", "Dbc1", "Mapre3", "Zzef1", "Gna12", "Gstm7", "Sv2b", "Tiam2", "Zfp46", "Ank3", "Calm2", "Nrn1", "Jph4", "Snap25", "Ttc3", "Oscp1", "Cntn2", "Fam49a", "Serpini1", "Rab3c", "Chst15", "Sv2a", "Dpysl3", "Sema4g", "Elavl3", "Vps13c", "Scn3a", "Nav3", "Cnr1", "Atp2b2", "Nnat", "Rufy3", "Tmsb10", "Nefm", "Tnfrsf21", "Kif21b", "Mcf2l", "Stmn1", "Gmnc", "Hecw1", "Enpp5", "L1cam", "Sorbs2", "Cdc42ep2", "Nmnat2", "Tuba1a", "Unc79", "Scn3b", "3632451O06Rik", "Pde1c", "Lrfn5", "Rtn2", "Gabrb2", "Slc17a6", "1700088E04Rik", "Trappc6a", "Psd", "Hmgcll1", "Nav1", "Tub", "Actl6b", "March8", "Pxk", "Tbr1", "Lrrc7", "Akap6", "Dscaml1", "Dnajc6", "Dopey2", "Galnt14", "Osbpl5", "Mllt11", "Sez6l2", "Nxph4", "Gabrg2", "Tubb3", "Chga", "Gdi1", "Dusp8", "Cd200", "Nrxn1", "Ralyl", "Mapk10", "Sox11", "Wnt7b", "Ndrg4", "Magel2", "Cbln4", "Dner", "Myt1l", "Dusp4", "Map2", "Syt4", "Atp1a3", "Smim18", "Ppfia2", "Plxna4", "Rtn1", "Map1b", "Snrpn", "Nrep", "Dcx", "Stmn2", "Tagln3")
weights2 <- c(2.136911, 9.205157, 15.04057, 14.38306, 15.63322, 15.21329, 7.556623, 15.73863, 15.24225, 14.90353, 16.34308, 4.423723, 16.73704, 12.81987, 15.2705, 16.21419, 14.84824, 15.80225, 15.23299, 14.40521, 9.90502, 16.11969, 12.89575, 3.311071, 17.46972, 18.18689, 15.31839, 16.47549, 15.68371, 16.4865, 12.65875, 15.94118, 3.6415, 15.56466, 18.86522, 17.09324, 17.45138, 17.43719, 14.81852, 16.76695, 16.04711, 16.71587, 8.95732, 15.21574, 16.57723, 17.9463, 18.28922, 17.0956, 18.51236, 14.47279, 8.607997, 16.33777, 17.69629, 18.0779, 18.39833, 8.384968, 17.93645, 3.883598, 18.37481, 19.62326, 7.079478, 18.46066, 18.57387, 19.86684, 17.57067, 17.17134, 19.19559, 17.28012, 19.51456, 18.63038, 16.346, 11.30094, 11.65711, 3.8573, 18.27631, 19.3324, 10.47136, 19.1688, 7.534274, 12.81903, 16.9127, 17.81924, 17.61544, 10.82315, 20.32141, 19.71257, 18.33481, 19.41048, 18.02951, 20.99936, 20.16026, 18.26461, 9.186602, 21.50746, 16.10645, 22.00737, 8.978131, 21.77559, 21.36687, 20.04521, 19.50468, 21.11922, 18.66986, 17.83665, 5.94918, 16.38831, 13.5438, 18.87614, 20.60921, 4.189785, 22.75836, 23.09122, 17.50587, 11.29154, 22.14349, 22.18913, 27.94501, 22.19199, 9.658578, 21.14181, 21.52989, 21.78602, 23.19786, 24.72262, 24.1665, 20.88067, 16.71132, 24.0294, 23.02293, 20.88419, 15.83706, 16.24816, 6.450837, 23.94848, 23.94848, 25.70524, 19.99748, 26.62003, 22.178, 24.94079, 24.08407, 26.47341, 6.700568, 28.2764, 22.20154, 25.95458, 6.91906, 25.88305, 22.42306, 27.05859, 30.87535, 21.7612, 22.35798, 25.03427, 17.46535, 27.2852, 16.16853, 27.74718, 31.36692, 28.40496, 35.20579, 30.09073, 8.811513, 18.08419, 7.209913, 25.47581, 25.36688, 31.83581, 28.58641, 6.66765, 30.0685, 31.42778, 30.04373, 29.97091, 27.10214, 30.83477, 25.14173, 8.179623, 29.54644, 30.6819, 31.9696, 31.49879, 31.99548, 33.65421, 32.11973, 37.97322, 24.91364, 31.93946, 30.68069, 33.96646, 30.45905, 34.63189, 34.76243, 35.00472, 35.09193, 39.13838, 33.9888, 37.8095, 35.00221, 32.88669, 35.75556, 38.66944, 36.92484, 21.31074, 38.37572, 35.98967, 31.81786, 30.92585, 30.85406, 22.2424, 39.26337, 40.44131, 41.71698, 39.48613, 38.26427, 14.63608, 40.31382, 40.53405, 42.45989, 43.87076, 43.02692, 45.8313, 41.15421, 27.19848, 48.42665, 45.21538, 48.54704, 48.93636, 47.4931, 33.36695, 19.00539, 46.4681, 31.47316, 56.75082, 60.46812, 28.49932)
gp <- gene.plot.weighted(gl2, weights2, mat, gannot3D, plot=F)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
plot.slice(gpsect, 'z', s, col=colorRampPalette(c("black", "red", "yellow"),space="Lab")(100), t=0)
# Comparison
gp <- gene.plot.weighted.comp(gl1, weights1, gl2, weights2, mat, gannot3D, plot=F)
#gp <- gene.plot.weighted.comp2(gl1, weights1, gl2, weights2, mat, gannot3D, plot=F)
#gp <- gene.plot.weighted.comp2(gl2, weights2, gl1, weights1, mat, gannot3D, plot=F)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
s <- 26
plot.slice.comp(gpsect, 'z', s)
#










# Random set of genes
gl <- sample(rownames(mat), 5)
gl <- c("Sox3", "Notch2")
gl <- c("Nfasc", "Neurod1")

# Weigh all equally for now
weights <- rep(1, length(gl))
# loading for group 1
weights1 <- c(4.484603, 5.481181, 5.56423, 4.733748, 3.986314, 5.854898, 2.491446, 4.692223, 4.85832, 4.193934, 6.47776, 1.204199, 4.027838, 4.276982, 5.190513, 4.650699, 4.899844, 4.401555, 3.529549, 3.778693, 3.778693, 3.654121, 3.612597, 3.072783, 4.650699, 4.235458, 3.695645, 4.235458, 3.363452, 1.370295, 3.861741, 4.484603, 1.287247, 4.193934, 3.612597, 4.982892, 3.031259, 2.948211, 4.360031, 3.571073, 3.363452, 4.733748, 3.197356, 3.612597, 3.197356, 2.657542, 3.612597, 2.491446, 2.53297, 2.200777, 2.242301, 3.695645, 3.23888, 5.481181, 1.660964, 2.491446, 2.699067, 4.85832, 2.076205, 1.910109, 4.360031, 1.577916, 2.449922, 2.366874, 2.034681, 3.94479, 2.034681, 1.536392, 2.782115, 2.034681, 4.360031, 4.193934, 0.5398133, 1.702488, 2.574494, 2.906687, 2.449922, 4.526127, 3.404976, 2.242301, 0.7474338, 0.7889579, 1.162675, 4.110886, 5.232037, 0.3737169, 1.494868, 1.702488, 1.744012, 0.9965784, 2.782115, 5.813374, 1.079627, 3.654121, 3.363452, 3.737169, 2.408398, 5.107464, 2.616018, 1.577916, 0.830482, 5.06594, 1.162675, 1.82706, 5.356609, 0.5398133, 3.321928, 2.989735, 4.484603, 0.5398133, 5.522705, 0.6643856, 0.2076205, 3.903266, 4.069362, 0.4982892, 3.321928, 0.830482, 2.699067, 4.069362, 0.5398133, 0.5398133, 1.868585, 1.079627, 4.069362, 1.494868, 3.155832, 1.993157, 2.574494, 1.245723, 0.8720061, 4.069362, 4.235458, 0.7059097, 1.536392, 3.986314, 0.4567651, 0.8720061, 1.82706, 0.415241, 1.744012, 0.7059097, 3.737169, 0.415241, 0.4982892, 4.484603, 0.3737169, 4.816796, 2.366874, 2.408398, 3.612597, 3.986314, 0.4567651, 2.823639, 2.117729, 2.034681, 0.4982892, 3.321928, 0.415241, 0.415241, 0.3737169, 0.3737169, 0.7889579, 1.038103, 2.32535, 1.245723, 0.0830482, 0.9135302, 0.0830482, 2.32535, 0.3321928, 1.162675, 1.370295, 3.778693, 3.363452, 0.4982892, 3.363452, 0.7059097, 3.280404, 3.571073, 3.404976, 2.782115, 1.245723, 4.484603, 0.4567651, 1.951633, 3.197356, 3.23888, 2.906687, 2.491446, 1.910109, 2.159253, 1.287247, 1.494868, 0.7474338, 0.3321928, 3.404976, 3.114308, 0.9135302, 2.159253, 2.699067, 0.3321928, 1.245723, 0.3321928, 2.906687, 3.820217, 2.159253, 0.0415241, 2.823639, 0.3737169, 1.577916, 0.3737169, 2.159253, 3.737169, 2.159253, 0.0415241, 2.408398, 2.32535, 2.782115, 1.785536, 3.321928, 0.2076205, 0.830482, 2.989735, 3.114308, 3.4465, 0.415241, 2.491446, 0.2076205, 2.283826, 0.4982892, 0.415241, 0.0415241, 3.404976, 0.7474338, 0.0415241, 1.993157, 0.2076205, 3.321928, 0.4567651, 3.23888, 2.699067, 1.785536, 2.657542, 0.1660964, 1.162675, 2.366874, 0.0415241, 1.82706, 3.072783, 2.034681, 1.61944, 0.3321928)
# loading for group 2
weights2 <- c(1.079627, 4.650699, 7.598911, 7.266718, 7.889579, 7.598911, 3.737169, 7.765007, 7.474338, 7.308242, 8.014152, 2.159253, 8.138724, 6.228615, 7.39129, 7.848055, 7.142145, 7.598911, 7.308242, 6.893001, 4.733748, 7.681959, 6.145567, 1.577916, 8.263296, 8.595489, 7.225194, 7.765007, 7.39129, 7.765007, 5.937946, 7.474338, 1.702488, 7.266718, 8.761585, 7.931103, 8.055676, 8.014152, 6.809953, 7.681959, 7.349766, 7.598911, 4.069362, 6.893001, 7.474338, 8.014152, 8.055676, 7.515862, 8.138724, 6.353187, 3.778693, 7.100621, 7.681959, 7.806531, 7.931103, 3.612597, 7.723483, 1.660964, 7.848055, 8.30482, 2.989735, 7.723483, 7.765007, 8.263296, 7.308242, 7.142145, 7.972627, 7.142145, 8.055676, 7.681959, 6.726904, 4.650699, 4.775272, 1.577916, 7.474338, 7.889579, 4.235458, 7.723483, 3.031259, 5.107464, 6.726904, 7.059097, 6.976049, 4.276982, 7.972627, 7.723483, 7.18367, 7.557386, 7.017573, 8.138724, 7.765007, 7.017573, 3.529549, 8.263296, 6.187091, 8.346344, 3.404976, 8.221772, 8.055676, 7.557386, 7.349766, 7.889579, 6.934525, 6.602332, 2.200777, 6.062519, 4.982892, 6.934525, 7.557386, 1.536392, 8.30482, 8.387868, 6.311663, 4.069362, 7.931103, 7.931103, 9.965784, 7.681959, 3.321928, 7.266718, 7.39129, 7.474338, 7.931103, 8.429393, 8.138724, 7.017573, 5.605754, 7.931103, 7.598911, 6.893001, 5.190513, 5.232037, 2.076205, 7.681959, 7.681959, 8.221772, 6.394712, 8.512441, 7.059097, 7.889579, 7.557386, 8.221772, 2.076205, 8.761585, 6.851477, 7.848055, 2.076205, 7.723483, 6.68538, 7.931103, 9.01073, 6.311663, 6.47776, 7.225194, 4.899844, 7.640435, 4.526127, 7.723483, 8.720061, 7.889579, 9.675116, 8.263296, 2.408398, 4.899844, 1.951633, 6.893001, 6.851477, 8.553965, 7.640435, 1.744012, 7.848055, 8.180248, 7.806531, 7.681959, 6.934525, 7.889579, 6.394712, 2.076205, 7.39129, 7.598911, 7.889579, 7.681959, 7.723483, 7.972627, 7.557386, 8.803109, 5.730326, 7.308242, 6.976049, 7.640435, 6.851477, 7.765007, 7.765007, 7.765007, 7.765007, 8.637013, 7.474338, 8.263296, 7.557386, 7.100621, 7.681959, 8.180248, 7.806531, 4.484603, 8.014152, 7.515862, 6.643856, 6.436236, 6.311663, 4.526127, 7.972627, 8.0972, 8.30482, 7.806531, 7.515862, 2.823639, 7.723483, 7.765007, 8.0972, 8.180248, 8.014152, 8.512441, 7.640435, 4.816796, 8.512441, 7.889579, 8.470917, 8.429393, 8.0972, 5.688802, 3.23888, 7.889579, 5.273561, 9.509019, 10.13188, 4.775272)
gp1 <- gene.plot.weighted(gl1, weights1, mat, gannot3D, plot=F)
gp2 <- gene.plot.weighted(gl2, weights2, mat, gannot3D, plot=F)
gp <- gp1-gp2
gp <- gp2-gp1
gp <- gp+abs(min(gp))
#plot.projection(gp, t=0)
gpsect <- structure.plot(cids, gp, gannot3D, plot=F)
#plot.projection(gpsect, t=0)
#plot.slice(gp^3, 'sagital', 25, t=1, col=colorRampPalette(c("black","red", "yellow"),space="Lab")(1024))
plot.slice(gpsect^3, 'sagital', 25, t=1, col=colorRampPalette(c("black","red", "yellow"),space="Lab")(1024))





gene.plot.weighted2 <- function(gl, weights, expmat, gannot, plot=F) {

  gl.have <- gl[gl %in% rownames(expmat)]
  weights.have <- weights[gl %in% rownames(expmat)]
  print(gl.have)
  print(weights.have)
  if(length(gl.have)==0) { print('No genes available'); return(NA); }

  exp <- expmat[gl.have,]
  exp[exp<0] <- NA
  # row normalize in case one gene just has higher detection due to better probes
  #exp <- t(t(exp) / rowMeans(exp, na.rm=T)^2)
  # weigh
  exp <- exp*weights.have
  if(length(gl.have) > 1) {
    #exp.int <- colSums(exp)
    exp.int <- colMeans(exp, na.rm=T)
  } else {
    exp.int <- exp
  }

  exp3D <- array(exp.int, dim=dim(gannot))

  if(plot) {
    plot.energy(exp3D, dim(gannot)[1], dim(gannot)[2], dim(gannot)[3])
  }

  return(exp3D)
}
plot.slice2 <- function(mat3D, direction, slice, col=colorRampPalette(c("white","black","red","yellow"),space="Lab")(1024), t=1) {
  require(lattice)
  mat3D.t <- mat3D
  ## threshold to get rid of noise
  if(direction=='axial') {
    levelplot(mat3D.t[,slice,], col.regions=col)
  }
  if(direction=='coronal') {
    levelplot(mat3D.t[slice,,], col.regions=col)
  }
  if(direction=='sagital') {
    levelplot(mat3D.t[,,slice], col.regions=col)
  }
}
structure.plot2 <- function(cids, vol, annot, plot=F) {
  tvol <- vol
  ## remove structures not in cids
  tvol[!(annot %in% cids)] <- NA
  if(plot) { plot.energy(tvol, dim(annot)[1], dim(annot)[2], dim(annot)[3]) }
  return(tvol)
}

# lb * Z
weights1 <- c(30.52403, 35.59604, 35.65595, 29.63018, 24.92804, 36.61185, 15.16621, 28.56126, 29.52103, 25.3812, 39.02558, 7.15174, 23.90375, 25.35708, 30.7121, 27.381, 28.742, 25.70101, 20.54915, 21.97657, 21.73686, 20.98872, 20.62802, 17.50842, 26.49535, 24.11755, 20.98421, 24.03879, 19.06746, 7.686197, 21.63342, 24.99209, 7.170615, 23.30865, 19.9971, 27.55747, 16.66067, 16.17579, 23.8201, 19.4994, 18.36461, 25.79052, 17.34443, 19.53527, 17.18905, 14.27702, 19.38363, 13.31105, 13.52004, 11.72554, 11.92854, 19.65148, 17.13138, 28.98168, 8.782288, 13.17281, 14.1886, 25.48809, 10.8671, 9.742223, 21.95198, 7.940798, 12.31239, 11.88447, 10.19132, 19.7512, 10.16627, 7.628988, 13.66115, 9.946574, 21.07952, 20.27337, 2.601532, 8.200584, 12.33137, 13.88331, 11.67138, 21.43675, 15.97611, 10.47494, 3.482677, 3.662744, 5.351528, 18.8898, 23.97443, 1.711369, 6.832801, 7.775117, 7.95928, 4.533954, 12.6406, 26.05055, 4.807234, 16.20491, 14.81379, 16.36579, 10.45364, 21.9492, 11.20439, 6.731916, 3.53909, 21.54709, 4.942369, 7.737812, 22.59674, 2.277189, 14.00545, 12.52804, 18.7799, 2.259539, 23.09672, 2.766994, 0.8602795, 16.16772, 16.77657, 2.053758, 13.61795, 3.403306, 11.05599, 16.64705, 2.203991, 2.192135, 7.584524, 4.362822, 16.40518, 6.022748, 12.71069, 8.012228, 10.3448, 4.972434, 3.463179, 16.06424, 16.71221, 2.770022, 6.00601, 15.54485, 1.768203, 3.374153, 7.033468, 1.595402, 6.698048, 2.710085, 14.33746, 1.583653, 1.899503, 17.08206, 1.42036, 18.23914, 8.961172, 9.087113, 13.62644, 14.97329, 1.708926, 10.55871, 7.908753, 7.589171, 1.855904, 12.35191, 1.539221, 1.536834, 1.375109, 1.371367, 2.894901, 3.785604, 8.474583, 4.517868, 0.3010178, 3.310643, 0.2997942, 8.362105, 1.19404, 4.171974, 4.915106, 13.50833, 11.98971, 1.776199, 11.98535, 2.512055, 11.63911, 12.66793, 12.07597, 9.848602, 4.407217, 15.82021, 1.610633, 6.854558, 11.22063, 11.346, 10.1576, 8.704499, 6.673117, 7.526675, 4.468678, 5.187734, 2.577015, 1.14352, 11.66755, 10.63732, 3.119934, 7.365385, 9.19418, 1.126901, 4.209151, 1.119456, 9.781033, 12.80576, 7.234985, 0.1384633, 9.412524, 1.240226, 5.218329, 1.235591, 7.128789, 12.31634, 7.104944, 0.1364111, 7.8349, 7.558342, 9.035621, 5.791046, 10.77091, 0.6716876, 2.684484, 9.654926, 10.05119, 11.10861, 1.333503, 7.981701, 0.6634929, 7.291318, 1.588474, 1.320485, 0.1318, 10.79523, 2.368559, 0.1313587, 6.279385, 0.6524635, 10.43008, 1.434077, 10.1508, 8.456726, 5.556866, 8.267294, 0.5166789, 3.616169, 7.337138, 0.1286599, 5.655351, 9.50546, 6.290978, 5.00649, 1.024651)
weights2 <- c(3.34872, 14.42752, 23.57851, 22.5526, 24.50295, 23.73269, 11.73107, 24.4204, 23.58077, 23.05718, 25.28586, 6.83181, 25.81125, 19.76516, 23.50666, 24.96674, 22.79585, 24.26661, 23.37266, 22.07577, 15.17529, 24.6639, 19.73231, 5.068771, 26.64945, 27.73696, 23.35126, 25.11511, 23.91484, 25.13839, 19.27182, 24.26828, 5.539777, 23.66568, 28.61008, 25.91511, 26.39141, 26.3148, 22.36641, 25.28244, 24.19792, 25.12296, 13.4663, 22.84588, 24.83902, 26.77293, 27.11407, 25.32546, 27.42822, 21.43686, 12.75164, 24.09623, 26.08962, 26.58681, 27.04554, 12.32766, 26.36847, 5.694515, 26.93029, 28.64601, 10.32575, 26.81169, 26.9774, 28.78857, 25.46263, 24.89069, 27.8196, 25.00454, 28.23257, 26.94407, 23.63282, 16.3395, 16.82284, 5.565121, 26.37654, 27.87786, 15.05395, 27.5178, 10.81764, 18.33479, 24.1751, 25.43856, 25.1492, 15.4429, 28.9177, 28.04277, 26.08317, 27.54498, 25.59385, 29.75894, 28.49341, 25.8003, 12.97962, 30.39424, 22.76504, 30.94667, 12.62651, 30.57357, 29.99044, 28.14169, 27.38896, 29.57099, 26.0838, 24.88596, 8.299981, 22.8643, 18.87157, 26.29408, 28.69091, 5.833494, 31.64197, 32.06068, 24.24258, 15.64381, 30.60737, 30.64932, 38.58595, 30.26887, 13.14613, 28.77459, 29.29459, 29.64185, 31.53023, 33.5709, 32.65643, 28.19944, 22.56578, 32.27922, 30.93297, 28.06224, 21.232, 21.65997, 8.600859, 31.9062, 31.91325, 34.22317, 26.62839, 35.4493, 29.49777, 33.13083, 31.92016, 34.96639, 8.846632, 37.35288, 29.29561, 33.9947, 9.039693, 33.75035, 29.23684, 35.07451, 39.97638, 28.12365, 28.89076, 32.30983, 22.32481, 34.86192, 20.66716, 35.4414, 40.05731, 36.28309, 44.81859, 38.30728, 11.20455, 22.9418, 9.146022, 32.32122, 32.18121, 40.32311, 36.14889, 8.379015, 37.76877, 39.47309, 37.72316, 37.48596, 33.88756, 38.56042, 31.40511, 10.21489, 36.73685, 38.04291, 39.64185, 38.95319, 39.45819, 41.26212, 39.30668, 46.30999, 30.35791, 38.89496, 37.33999, 41.25876, 37.00225, 42.07124, 42.21206, 42.49694, 42.58682, 47.51577, 41.236, 45.84166, 42.37219, 39.83397, 43.27807, 46.76669, 44.67205, 25.7631, 46.35298, 43.49025, 38.4743, 37.3794, 37.23418, 26.83551, 47.47212, 48.72283, 50.24909, 47.66145, 46.13689, 17.56821, 48.48287, 48.80012, 51.1071, 52.57678, 51.61457, 55.00612, 49.45635, 32.33245, 57.53664, 53.7774, 57.75204, 58.25209, 56.50203, 39.79881, 22.73825, 55.73391, 37.76296, 68.09263, 72.55284, 34.19499)
weights <- c(weights1, -weights2)
gl <- c(gl1, gl2)
gp <- gene.plot.weighted2(gl, weights, mat, gannot3D, plot=F)
table(is.na(gp))
# Just pallium
sid <- get.id(structure.id, 'pallium')
cids <- c(sid, get.children(structure.id, sid))
gpsect <- structure.plot2(cids, gp, gannot3D, plot=F)
col <- colorRampPalette(c("green", "blue", "black", "red", "yellow"),space="Lab")(1024)
plot.slice2(gpsect, 'sagital', 25, t=1, col=col)
plot.slice2(gp, 'sagital', 25, t=1, col=col)
#




